<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åŸºé‡‘ä¸ A è‚¡å¸‚å€¼åˆ†æç³»ç»Ÿ - ç¨³å®šç‰ˆ</title>
</head>
<body style="font-family: 'PingFang SC', sans-serif; background: #f0f2f5; padding: 20px; margin: 0;">

<div style="max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; background: #fafafa; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee;">
        <div>
            <span id="stDot" style="width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; background: #bfbfbf;"></span>
            <span id="stTxt" style="font-weight: bold; font-size: 13px; color: #666;">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</span>
        </div>
        <div style="font-size: 12px; color: #999;">
            <button onclick="exportData()" style="padding: 4px 8px; cursor: pointer; background: #fff; border: 1px solid #d9d9d9; border-radius: 4px;">ğŸ’¾ å¤‡ä»½</button>
            <button onclick="importData()" style="padding: 4px 8px; cursor: pointer; background: #fff; border: 1px solid #d9d9d9; border-radius: 4px; margin-left: 5px;">ğŸ“‚ å¯¼å…¥</button>
            <input type="file" id="fileInput" style="display:none" onchange="handleFile(this)">
        </div>
    </div>

    <table style="width: 100%; border-spacing: 12px; border-collapse: separate; margin-bottom: 10px;">
        <tr>
            <td style="width: 50%; background: linear-gradient(135deg, #1890ff, #096dd9); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">åŸºé‡‘æŒä»“æ€»é‡‘é¢ (äº¿å…ƒ)</div>
                <div style="font-size: 36px; font-weight: bold; margin: 5px 0;" id="fVal">0.00</div>
            </td>
            <td style="width: 50%; background: linear-gradient(135deg, #722ed1, #531dab); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">A è‚¡æ€»å¸‚å€¼ (ä¸‡äº¿å…ƒ)</div>
                <div style="font-size: 36px; font-weight: bold; margin: 5px 0;" id="mVal">0.00</div>
            </td>
        </tr>
    </table>

    <div style="margin-bottom: 30px;">
        <h3 style="border-left: 4px solid #1890ff; padding-left: 10px; font-size: 16px;">ğŸ“‹ èµ„äº§æ˜ç»†ç®¡ç†</h3>
        <table style="width: 100%; border-collapse: collapse; background: #fff; font-size: 14px;">
            <thead>
                <tr style="background: #fafafa; color: #8c8c8c; text-align: left;">
                    <th style="padding: 12px; border-bottom: 2px solid #f0f0f0;">ä»£ç </th>
                    <th style="padding: 12px; border-bottom: 2px solid #f0f0f0;">åç§°</th>
                    <th style="padding: 12px; border-bottom: 2px solid #f0f0f0;">ä»½é¢(äº¿)</th>
                    <th style="padding: 12px; border-bottom: 2px solid #f0f0f0;">æœ€æ–°å‡€å€¼</th>
                    <th style="padding: 12px; border-bottom: 2px solid #f0f0f0; text-align: right;">æŒä»“é‡‘é¢(äº¿)</th>
                    <th style="padding: 12px; border-bottom: 2px solid #f0f0f0; text-align: center;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="detailList"></tbody>
        </table>
        
        <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border: 1px dashed #d9d9d9; border-radius: 8px; display: flex; gap: 10px;">
            <input type="text" id="inCode" placeholder="ä»£ç (510300)" style="flex:1; padding:8px; border:1px solid #d9d9d9; border-radius:4px;">
            <input type="number" id="inShares" placeholder="ä»½é¢(äº¿)" style="flex:1; padding:8px; border:1px solid #d9d9d9; border-radius:4px;">
            <button onclick="addOne()" style="background:#52c41a; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">â• å¢åŠ è¿½è¸ª</button>
        </div>
    </div>

    <button style="width:100%; padding:16px; background:#1890ff; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; margin-bottom:30px;" onclick="syncAll()">ğŸš€ ç«‹å³åŒæ­¥å…¨é‡æ•°æ®</button>

    <h3 style="border-left: 4px solid #722ed1; padding-left: 10px; font-size: 16px;">ğŸ“ˆ å†å²è®°å½•</h3>
    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
        <tbody id="hList"></tbody>
    </table>
</div>

<script>
    const defFunds = [{c:'510300', s:515}, {c:'510310', s:349.7}, {c:'159919', s:220.7}, {c:'510330', s:209.9}, {c:'510050', s:282.6}, {c:'159915', s:199.3}, {c:'159949', s:154.6}, {c:'510500', s:140.3}, {c:'512100', s:110.6}];
    const BASE_VAL = 17210.00;
    let myFunds = JSON.parse(localStorage.getItem('v_stable_funds')) || defFunds;
    let fundCache = {};

    window.onload = () => {
        renderHistory();
        syncAll(); // é¡µé¢æ‰“å¼€å³è‡ªåŠ¨åŒæ­¥
        setInterval(autoTask, 60000);
    };

    function autoTask() {
        const h = new Date().getHours();
        if (h >= 8 && localStorage.getItem('v_stable_day') !== new Date().toLocaleDateString()) {
            syncAll();
        }
    }

    async function syncAll() {
        document.getElementById('stTxt').innerText = 'æ­£åœ¨æŠ“å–æ•°æ®...';
        const codes = myFunds.map(f => (f.c.startsWith('5') || f.c.startsWith('6') ? 'sh' : 'sz') + f.c).join(',') + ',sh000001';
        
        try {
            // é‡‡ç”¨äºŒè¿›åˆ¶æµæ–¹å¼è¯»å–ï¼Œè§£å†³ GBK ä¹±ç 
            const response = await fetch(`http://localhost:3000/q=${codes}`);
            const buffer = await response.arrayBuffer();
            const decoder = new TextDecoder('gbk');
            const txt = decoder.decode(buffer);
            
            let totalAmt = 0;
            myFunds.forEach(f => {
                const regex = new RegExp(f.c + '="([^"]+)"');
                const m = txt.match(regex);
                if (m) {
                    const data = m[1].split('~');
                    const name = data[1] || 'æœªçŸ¥';
                    const price = parseFloat(data[3]);
                    fundCache[f.c] = { name, price };
                    if (!isNaN(price)) totalAmt += (price * f.s);
                }
            });

            const mMatch = txt.match(/sh000001="([^"]+)"/);
            let mVal = (mMatch ? (parseFloat(mMatch[1].split('~')[3]) * 0.0263).toFixed(1) : "86.5");

            document.getElementById('fVal').innerText = totalAmt.toFixed(2);
            document.getElementById('mVal').innerText = mVal;
            document.getElementById('stDot').className = 'dot';
            document.getElementById('stDot').style.background = '#52c41a';
            document.getElementById('stTxt').innerText = 'åŒæ­¥å®Œæˆ (' + new Date().toLocaleTimeString() + ')';

            saveHistory(totalAmt.toFixed(2), mVal);
            localStorage.setItem('v_stable_day', new Date().toLocaleDateString());
            renderDetails();
        } catch (e) {
            document.getElementById('stTxt').innerText = 'ä»£ç†æœªå¯åŠ¨';
            document.getElementById('stDot').style.background = '#ff4d4f';
        }
    }

    function renderDetails() {
        const body = document.getElementById('detailList');
        body.innerHTML = myFunds.map((f, i) => {
            const info = fundCache[f.c] || { name: 'è½½å…¥ä¸­...', price: 0 };
            return `<tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:12px;">${f.c}</td>
                <td style="padding:12px; font-weight:bold;">${info.name}</td>
                <td style="padding:12px;">${f.s}</td>
                <td style="padding:12px; color:#cf1322;">${info.price.toFixed(3)}</td>
                <td style="padding:12px; text-align:right; font-weight:bold;">${(info.price * f.s).toFixed(2)} äº¿</td>
                <td style="padding:12px; text-align:center;"><button onclick="dropFund(${i})" style="color:#ff4d4f; border:none; background:none; cursor:pointer;">åˆ é™¤</button></td>
            </tr>`;
        }).join('');
    }

    function addOne() {
        const c = document.getElementById('inCode').value.trim();
        const s = parseFloat(document.getElementById('inShares').value);
        if(c && s) {
            myFunds.push({c, s});
            localStorage.setItem('v_stable_funds', JSON.stringify(myFunds));
            document.getElementById('inCode').value = '';
            document.getElementById('inShares').value = '';
            syncAll();
        }
    }

    function dropFund(i) {
        if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
            myFunds.splice(i, 1);
            localStorage.setItem('v_stable_funds', JSON.stringify(myFunds));
            renderDetails();
            syncAll();
        }
    }

    function exportData() {
        const blob = new Blob([JSON.stringify({f: myFunds, h: JSON.parse(localStorage.getItem('v_stable_hist') || '[]')})], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æŒä»“å¤‡ä»½_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importData() { document.getElementById('fileInput').click(); }

    function handleFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = JSON.parse(e.target.result);
            if(data.f) {
                myFunds = data.f;
                localStorage.setItem('v_stable_funds', JSON.stringify(myFunds));
                localStorage.setItem('v_stable_hist', JSON.stringify(data.h || []));
                location.reload();
            }
        };
        reader.readAsText(input.files[0]);
    }

    function saveHistory(f, m) {
        const d = new Date(); d.setDate(d.getDate() - 1);
        const dt = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        let h = JSON.parse(localStorage.getItem('v_stable_hist') || '[]');
        if (h.length > 0 && h[0].dt === dt) return;
        h.unshift({ dt, f, m, diff: (f - BASE_VAL).toFixed(2) });
        localStorage.setItem('v_stable_hist', JSON.stringify(h));
        renderHistory();
    }

    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('v_stable_hist') || '[]');
        document.getElementById('hList').innerHTML = `<tr style="background:#fffbe6; font-weight:bold;"><td>2025/12/31 (åŸºå‡†)</td><td style="text-align:right;">17210.00</td><td style="text-align:right;">88.5</td><td style="text-align:right;">--</td></tr>` + 
            h.map(i => `<tr><td style="padding:10px; border-bottom:1px solid #eee;">${i.dt}</td><td style="text-align:right; border-bottom:1px solid #eee;">${i.f}</td><td style="text-align:right; border-bottom:1px solid #eee;">${i.m}</td><td style="text-align:right; border-bottom:1px solid #eee; color:${i.diff>0?'#cf1322':'#389e0d'}">${i.diff>0?'+':''}${i.diff}</td></tr>`).join('');
    }
</script>
</body>
</html>