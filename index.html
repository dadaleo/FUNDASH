<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åŸºé‡‘ AUM æŒä»“åˆ†æç³»ç»Ÿ (é€»è¾‘ä¿®æ­£ç‰ˆ)</title>
</head>
<body style="font-family: 'PingFang SC', sans-serif; background: #f0f2f5; padding: 20px; margin: 0;">

<div style="max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; background: #fafafa; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee;">
        <div>
            <span id="stDot" style="width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; background: #bfbfbf;"></span>
            <span id="stTxt" style="font-weight: bold; font-size: 13px; color: #666;">æœ¬åœ° Node.js ä»£ç†è¿æ¥ä¸­...</span>
        </div>
        <div style="font-size: 12px; color: #999;">
            <button onclick="exportData()" style="padding: 4px 8px; cursor: pointer;">ğŸ’¾ å¤‡ä»½</button>
            <button onclick="importData()" style="padding: 4px 8px; cursor: pointer; margin-left: 5px;">ğŸ“‚ å¯¼å…¥</button>
            <input type="file" id="fileInput" style="display:none" onchange="handleFile(this)">
        </div>
    </div>

    <table style="width: 100%; border-spacing: 12px; border-collapse: separate; margin-bottom: 10px;">
        <tr>
            <td style="width: 50%; background: linear-gradient(135deg, #1890ff, #096dd9); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">å½“å‰æŒä»“æ€» AUM (å®æ—¶/äº¿å…ƒ)</div>
                <div style="font-size: 36px; font-weight: bold; margin: 5px 0;" id="fVal">0.00</div>
            </td>
            <td style="width: 50%; background: linear-gradient(135deg, #722ed1, #531dab); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">A è‚¡æ€»å¸‚å€¼ä¼°ç®— (ä¸‡äº¿å…ƒ)</div>
                <div style="font-size: 36px; font-weight: bold; margin: 5px 0;" id="mVal">0.00</div>
            </td>
        </tr>
    </table>

    <div style="margin-bottom: 30px;">
        <h3 style="border-left: 4px solid #1890ff; padding-left: 10px; font-size: 16px;">ğŸ“‹ å®˜æ–¹ AUM èµ„äº§æ˜ç»† (2025/12/31 åŸºå‡†)</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: #fff; font-size: 13px;">
                <thead>
                    <tr style="background: #fafafa; color: #8c8c8c; text-align: left;">
                        <th style="padding: 10px; border-bottom: 2px solid #f0f0f0;">ä»£ç </th>
                        <th style="padding: 10px; border-bottom: 2px solid #f0f0f0;">åç§°</th>
                        <th style="padding: 10px; border-bottom: 2px solid #f0f0f0;">å½“å‰ä»½é¢(äº¿)</th>
                        <th style="padding: 10px; border-bottom: 2px solid #f0f0f0; background:#f0f5ff;">25å¹´æœ«è§„æ¨¡</th>
                        <th style="padding: 10px; border-bottom: 2px solid #f0f0f0; color:#1890ff;">æ˜¨æ—¥ç¯æ¯”å¢å‡</th>
                        <th style="padding: 10px; border-bottom: 2px solid #f0f0f0;">æœ€æ–°å•ä½å‡€å€¼</th>
                        <th style="padding: 10px; border-bottom: 2px solid #f0f0f0; text-align: right;">å½“å‰æŒä»“é‡‘é¢</th>
                    </tr>
                </thead>
                <tbody id="detailList"></tbody>
            </table>
        </div>
    </div>

    <button style="width:100%; padding:16px; background:#52c41a; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; margin-bottom:30px;" onclick="syncAll()">ğŸš€ åŒæ­¥æœ€æ–° AUM æ•°æ® (æœ¬åœ°ä»£ç†)</button>

    <h3 style="border-left: 4px solid #722ed1; padding-left: 10px; font-size: 16px;">ğŸ“ˆ å†å²è®°å½• (åŸºå‡†: 17682.47 äº¿)</h3>
    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
        <thead>
            <tr style="background: #eee;">
                <th style="padding:10px; text-align:left;">æ—¥æœŸ</th>
                <th style="text-align:right; padding:10px;">æ€» AUM (äº¿)</th>
                <th style="text-align:right; padding:10px;">A è‚¡å¸‚å€¼ (ä¸‡äº¿)</th>
                <th style="text-align:right; padding:10px;">è¾ƒå¹´åˆå¢å‡</th>
            </tr>
        </thead>
        <tbody id="hList"></tbody>
    </table>
</div>

<script>
    // å®˜æ–¹ AUM åŸºå‡†æ€»é¢ (11 åªåŸºé‡‘åˆè®¡)
    const BASE_VAL = 17682.47;
    
    // é»˜è®¤æ•°æ®ç§å­
    const defFunds = [
        {"c":"510300","s":888.3,"lyp":4.7536,"oldS":888.3},
        {"c":"510310","s":659.34,"lyp":4.5533,"oldS":659.34},
        {"c":"512100","s":256.5122,"lyp":3.0796,"oldS":256.5122}
    ];
    
    let myFunds = JSON.parse(localStorage.getItem('v_stable_funds')) || defFunds;
    let fundCache = {};

    window.onload = () => {
        renderHistory();
        syncAll();
    };

    async function syncAll() {
        document.getElementById('stTxt').innerText = 'æ•°æ®åŒæ­¥ä¸­...';
        const codes = myFunds.map(f => (f.c.startsWith('5') || f.c.startsWith('6') ? 'sh' : 'sz') + f.c).join(',') + ',sh000001';
        
        try {
            const response = await fetch(`https://fundash.onrender.com/q=${codes}`);
            const buffer = await response.arrayBuffer();
            const decoder = new TextDecoder('gbk');
            const txt = decoder.decode(buffer);
            
            let totalAmt = 0;
            const today = new Date().toLocaleDateString();
            const isNewDay = localStorage.getItem('v_stable_day') !== today;

            myFunds.forEach(f => {
                const regex = new RegExp(f.c + '="([^"]+)"');
                const m = txt.match(regex);
                if (m) {
                    const data = m[1].split('~');
                    const price = parseFloat(data[3]);

                    // ã€ä¿®æ­£ã€‘ï¼šæ–°çš„ä¸€å¤©å¼€å§‹æ—¶ï¼ŒæŠŠæ˜¨æ—¥çš„â€œæˆæœâ€å›ºåŒ–
                    if (isNewDay && fundCache[f.c]) {
                        f.pp = fundCache[f.c].price; // é”å®šæ˜¨æ—¥å‡€å€¼
                        f.oldS = f.s;                // é”å®šæ˜¨æ—¥ä»½é¢
                    }
                    
                    fundCache[f.c] = { name: data[1], price: price };
                    if (!isNaN(price)) totalAmt += (price * f.s);
                }
            });

            const mMatch = txt.match(/sh000001="([^"]+)"/);
            let mVal = (mMatch ? (parseFloat(mMatch[1].split('~')[3]) * 0.0263).toFixed(1) : "88.5");

            document.getElementById('fVal').innerText = totalAmt.toFixed(2);
            document.getElementById('mVal').innerText = mVal;
            document.getElementById('stDot').style.background = '#52c41a';
            document.getElementById('stTxt').innerText = 'åŒæ­¥å®Œæˆ (' + new Date().toLocaleTimeString() + ')';

            if (isNewDay) {
                saveHistory(totalAmt.toFixed(2), mVal);
                localStorage.setItem('v_stable_day', today);
                localStorage.setItem('v_stable_funds', JSON.stringify(myFunds));
            }
            renderDetails();
        } catch (e) {
            document.getElementById('stTxt').innerText = 'ä»£ç†è¿æ¥å¤±è´¥';
            document.getElementById('stDot').style.background = '#ff4d4f';
        }
    }

    function renderDetails() {
        const body = document.getElementById('detailList');
        body.innerHTML = myFunds.map((f, i) => {
            const info = fundCache[f.c] || { name: '...', price: 0 };
            
            // 1. è®¡ç®—ã€å½“å‰ã€‘æ€»é‡‘é¢ = æœ€æ–°å‡€å€¼ * å½“å‰ä»½é¢
            const curAmt = info.price * f.s;
            
            // 2. è®¡ç®—ã€25å¹´åº•ã€‘è§„æ¨¡åŸºå‡† = å»å¹´æœ«å‡€å€¼ * å½“å‰ä»½é¢ (åæ˜ å¦‚æœè¡Œæƒ…ä¸åŠ¨ï¼ŒåŸºå‡†æ˜¯å¤šå°‘)
            const lyAmt = (f.lyp || 0) * f.s;
            
            // 3. è®¡ç®—ã€æ˜¨æ—¥ç¯æ¯”ã€‘= å½“å‰æ€»é‡‘é¢ - (æ˜¨æ—¥å‡€å€¼ * æ˜¨æ—¥ä»½é¢)
            const yesterdayAmt = (f.pp || info.price) * (f.oldS || f.s);
            const dayDiff = curAmt - yesterdayAmt;

            return `<tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px;">${f.c}</td>
                <td style="padding:10px; font-weight:bold;">${info.name}</td>
                <td style="padding:10px;">${f.s}</td>
                <td style="padding:10px; color:#8c8c8c; background:#f0f5ff;">${lyAmt.toFixed(2)} äº¿</td>
                <td style="padding:10px; font-weight:bold; color:${dayDiff >= 0 ? '#cf1322' : '#389e0d'}">
                    ${dayDiff >= 0 ? '+' : ''}${dayDiff.toFixed(2)} äº¿
                </td>
                <td style="padding:10px; color:#cf1322;">${info.price.toFixed(3)}</td>
                <td style="padding:10px; text-align:right; font-weight:bold;">${curAmt.toFixed(2)} äº¿</td>
            </tr>`;
        }).join('');
    }

    function saveHistory(f, m) {
        const d = new Date(); d.setDate(d.getDate() - 1);
        const dt = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        let h = JSON.parse(localStorage.getItem('v_stable_hist') || '[]');
        if (h.length > 0 && h[0].dt === dt) return;
        h.unshift({ dt, f, m, diff: (f - BASE_VAL).toFixed(2) });
        localStorage.setItem('v_stable_hist', JSON.stringify(h));
        renderHistory();
    }

    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('v_stable_hist') || '[]');
        document.getElementById('hList').innerHTML = `<tr style="background:#fffbe6; font-weight:bold;"><td>2025/12/31 (åŸºå‡†)</td><td style="text-align:right; padding:10px;">17682.47</td><td style="text-align:right; padding:10px;">88.5</td><td style="text-align:right; padding:10px;">--</td></tr>` + 
            h.map(i => `<tr><td style="padding:10px;">${i.dt}</td><td style="text-align:right; padding:10px;">${i.f}</td><td style="text-align:right; padding:10px;">${i.m}</td><td style="text-align:right; padding:10px; color:${i.diff>0?'#cf1322':'#389e0d'}">${i.diff>0?'+':''}${i.diff}</td></tr>`).join('');
    }

    function exportData() {
        const blob = new Blob([JSON.stringify({f: myFunds, h: JSON.parse(localStorage.getItem('v_stable_hist') || '[]')})], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `æŒä»“å¤‡ä»½_${new Date().toLocaleDateString()}.json`; a.click();
    }
    function importData() { document.getElementById('fileInput').click(); }
    function handleFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = JSON.parse(e.target.result);
            if(data.f) {
                myFunds = data.f;
                localStorage.setItem('v_stable_funds', JSON.stringify(myFunds));
                localStorage.setItem('v_stable_hist', JSON.stringify(data.h || []));
                location.reload();
            }
        };
        reader.readAsText(input.files[0]);
    }
</script>
</body>
</html>